# GitHub Issues Integration

## Overview

Auditvia can automatically create GitHub Issues for accessibility violations found during scans. The integration supports two modes:

- **Issue-Only Mode** (default): Create tracking issues in a project management or issues-only repository
- **PR Mode** (coming soon): Generate automated pull requests with code fixes in your codebase repository

Each issue includes comprehensive details including:

- Violation description and impact level
- WCAG compliance tags and references
- Step-by-step remediation guidance
- Code examples (before/after)
- Technical details (CSS selector, HTML snippet)
- Direct link back to the Auditvia report

## Setup

### 1. Create a GitHub Personal Access Token (PAT)

1. Go to GitHub ‚Üí Settings ‚Üí Developer settings ‚Üí Personal access tokens ‚Üí Tokens (classic)
2. Click "Generate new token (classic)"
3. Give it a descriptive name (e.g., "Auditvia Integration")
4. Select required scopes:
   - ‚úÖ `repo` (Full control of private repositories)
     - This includes `repo:status`, `repo_deployment`, `public_repo`
5. Set an appropriate expiration date
6. Click "Generate token"
7. **Copy the token immediately** - you won't be able to see it again!

### 2. Configure Environment Variable

Add the GitHub token to your `.env.local` file:

```bash
# GitHub Integration
GITHUB_TOKEN=ghp_your_token_here
```

**Security Notes:**
- Never commit this token to version control
- The token is only used server-side
- It's never exposed to the client

### 3. Configure Repository for a Site

#### Option A: Configure Before Creating Issues

1. Go to your site's settings (dashboard ‚Üí site card ‚Üí settings)
2. Find the "GitHub Integration" section
3. Select your integration mode:
   - **Issue-Only**: For tracking issues in a project management repo
   - **PR Mode**: (Coming soon) For automated code fixes
4. Enter your repository in the format: `owner/repo`
   - Example: `acme-corp/website-issues`
5. Click "Validate" to verify the repository exists and is accessible
6. Click "Save Repository Settings"

#### Option B: Configure When Creating First Issue

1. Open a scan report with violations
2. Expand any violation
3. Click "Create GitHub Issue" (or "Generate Fix PR" in PR mode)
4. If no repository is configured, a modal will appear
5. Enter your repository: `owner/repo`
6. Click "Save Repository"
7. The issue will be created automatically

## Usage

### Creating an Issue from a Violation

1. Navigate to a completed scan report
2. Find a violation you want to create an issue for
3. Click to expand the violation details
4. Click the **"Generate Fix PR"** button
5. The system will:
   - Verify repository configuration
   - Create a detailed GitHub Issue
   - Show a success toast with a link to the issue
6. Click the link in the toast to view the created issue on GitHub

### Issue Format

Each created issue includes:

**Title:**
```
Fix: [rule-id] at [selector]
```

**Body:**
```markdown
## üîç Accessibility Issue Detected

**Impact:** üî¥ Critical
**Site:** https://example.com
**Element:** `button.submit-btn`

### Description
[Human-readable description of the issue]

### üìã WCAG Compliance
**Tags:** [`wcag2aa`](link) ¬∑ [`wcag412`](link)
**Reference:** WCAG 2.1 Level AA - Success Criterion 4.1.2

### üîß How to Fix
1. Add visible text inside the button element
2. For icon-only buttons, add an aria-label attribute
3. Ensure the label clearly describes the button's action
[... additional steps ...]

### üíª Code Example
\`\`\`html
<!-- Before -->
<button><i class="icon-save"></i></button>

<!-- After -->
<button aria-label="Save document"><i class="icon-save"></i></button>
\`\`\`

### üîç Technical Details
**CSS Selector:**
\`\`\`css
button.submit-btn
\`\`\`

**HTML Snippet:**
\`\`\`html
<button class="submit-btn"></button>
\`\`\`

---

üìä **[View Full Report in Auditvia](https://auditvia.com/dashboard/reports/scan-id)**

*This issue was automatically generated by [Auditvia](https://auditvia.com) - Accessibility Compliance Made Simple*
```

**Labels:**
- `accessibility`
- `severity:critical` (or serious/moderate/minor)
- `wcag:rule-id`
- `mode:issue_only` (or pr)
- `auditvia`

## Troubleshooting

### Error: "GitHub repository not configured"

**Solution:** Configure your repository:
1. Go to site settings
2. Add repository in format: `owner/repo`
3. Save changes

### Error: "Repository not found"

**Possible causes:**
- Repository name is incorrect
- Repository is private and token doesn't have access
- Repository was deleted or renamed

**Solution:**
1. Verify the repository exists on GitHub
2. Check the repository name format: `owner/repo`
3. Ensure your PAT has `repo` scope
4. Update the repository name in site settings

### Error: "GitHub authentication failed"

**Possible causes:**
- Token has expired
- Token was revoked
- Token doesn't have required `repo` scope

**Solution:**
1. Create a new Personal Access Token
2. Ensure it has `repo` scope
3. Update `GITHUB_TOKEN` in `.env.local`
4. Restart the server

### Error: "Missing required data to create GitHub issue"

**Possible causes:**
- Violation data is incomplete
- Site ID or Scan ID is missing

**Solution:**
- Refresh the page and try again
- If the issue persists, check browser console for errors

## Advanced Configuration

### Environment Variables

```bash
# Required: GitHub Personal Access Token
GITHUB_TOKEN=ghp_your_token_here

# Optional: Future PR mode (currently not implemented)
# GITHUB_PR_MODE=false  # When true, will create PRs instead of issues
```

### Repository Validation

Repository names must match the format: `owner/repo`

**Valid examples:**
- `acme-corp/website`
- `john-doe/my-app`
- `my_org/project-123`

**Invalid examples:**
- `acme-corp` (missing repo name)
- `https://github.com/acme-corp/website` (includes URL)
- `acme corp/website` (contains spaces)

### Rate Limits

GitHub API has rate limits:
- **Authenticated requests:** 5,000 per hour
- **Creating issues:** Subject to abuse rate limits

If you hit rate limits:
- Wait for the limit to reset (typically 1 hour)
- Consider creating issues in batches
- Use a dedicated token for Auditvia

## Future Enhancements

### Pull Request Mode (Planned)

In the future, Auditvia will support creating Pull Requests with actual code fixes:

```bash
GITHUB_PR_MODE=true  # Enable PR creation
```

When enabled:
- Creates a new branch
- Commits suggested fixes
- Opens a Pull Request
- Links back to Auditvia report

### Bulk Issue Creation (Planned)

Create multiple issues at once:
- Select multiple violations
- Click "Create All Issues"
- Issues are created in sequence
- Progress indicator shows status

## Security Best Practices

1. **Token Security:**
   - Use tokens with minimal required scopes
   - Rotate tokens periodically
   - Revoke tokens immediately if compromised

2. **Repository Access:**
   - Only configure repositories your team owns
   - Verify repository names before saving
   - Use organization-owned repos when possible

3. **Audit Logging:**
   - All issue creations are logged
   - Analytics track usage patterns
   - Monitor for unusual activity

## Support

### Common Questions

**Q: Can I use the same token for multiple sites?**
A: Yes, one token can be used for all sites, as long as it has access to all configured repositories.

**Q: Will issues be created for every violation?**
A: No, issues are only created when you explicitly click "Generate Fix PR" on a violation.

**Q: Can I edit the issue after it's created?**
A: Yes, you can edit the issue directly on GitHub. Future updates from Auditvia won't overwrite your changes.

**Q: What if I delete a created issue?**
A: Auditvia doesn't track issue status. You can recreate it by clicking "Generate Fix PR" again.

**Q: Can I customize the issue template?**
A: Not currently, but this is planned for a future release.

For additional support, please contact the Auditvia team or open an issue on our GitHub repository.

## API Reference

### POST /api/github/create-issue

Create a GitHub Issue for an accessibility violation.

**Request Body:**
```typescript
{
  siteId: string
  scanId: string
  violation: {
    id: string
    ruleId: string
    impact: 'critical' | 'serious' | 'moderate' | 'minor'
    selector: string
    html?: string
    description: string
    wcagTags?: string[]
  }
}
```

**Response:**
```typescript
{
  success: true
  issueUrl: string    // e.g., "https://github.com/owner/repo/issues/123"
  issueNumber: number // e.g., 123
  repo: string       // e.g., "owner/repo"
}
```

**Error Codes:**
- `UNAUTHORIZED` - User not authenticated
- `SITE_NOT_FOUND` - Site doesn't exist or user doesn't have access
- `REPO_NOT_CONFIGURED` - Repository not set for this site
- `INVALID_REPO_FORMAT` - Repository format is invalid
- `GITHUB_NOT_CONFIGURED` - GITHUB_TOKEN not set on server
- `REPO_NOT_FOUND` - Repository doesn't exist or token doesn't have access
- `GITHUB_AUTH_FAILED` - Token authentication failed
- `GITHUB_ERROR` - Generic GitHub API error

### POST /api/github/validate-repo

Validate that a GitHub repository exists and is accessible.

**Request Body:**
```typescript
{
  repository: string  // Format: "owner/repo"
}
```

**Response:**
```typescript
{
  valid: true
  repository: string     // e.g., "owner/repo"
  owner: string         // e.g., "owner"
  repo: string          // e.g., "repo"
  isPrivate: boolean    // Repository visibility
  hasAccess: boolean    // Token has access
}
```

**Error Codes:**
- `UNAUTHORIZED` - User not authenticated
- `GITHUB_NOT_CONFIGURED` - GITHUB_TOKEN not set on server
- `MISSING_REPOSITORY` - No repository provided
- `INVALID_FORMAT` - Repository format is invalid
- `REPO_NOT_FOUND` - Repository doesn't exist
- `ACCESS_DENIED` - Token doesn't have access to repository

### PATCH /api/sites/[siteId]

Update a site's GitHub repository configuration.

**Request Body:**
```typescript
{
  github_repo?: string           // Format: "owner/repo"
  repository_mode?: 'issue_only' | 'pr'  // Integration mode
}
```

**Response:**
```typescript
{
  site: {
    id: string
    name: string
    url: string
    github_repo: string
    // ... other site fields
  }
}
```

## Migration Guide

If you're adding this feature to an existing Auditvia installation:

1. Apply the database migrations:
   ```bash
   # Add github_repo column
   supabase migration apply 0057_add_github_repo_to_sites
   
   # Add repository_mode column
   supabase migration apply 0058_add_repository_mode
   ```
   
   Or apply the SQL directly in Supabase Dashboard:
   ```sql
   -- Add github_repo column
   ALTER TABLE public.sites ADD COLUMN IF NOT EXISTS github_repo TEXT;
   CREATE INDEX IF NOT EXISTS idx_sites_github_repo ON public.sites(github_repo) WHERE github_repo IS NOT NULL;
   
   -- Add repository_mode enum and column
   CREATE TYPE repository_mode AS ENUM ('issue_only', 'pr');
   ALTER TABLE public.sites ADD COLUMN IF NOT EXISTS repository_mode repository_mode DEFAULT 'issue_only';
   UPDATE public.sites SET repository_mode = 'issue_only' WHERE github_repo IS NOT NULL;
   CREATE INDEX IF NOT EXISTS idx_sites_repository_mode ON public.sites(repository_mode) WHERE repository_mode IS NOT NULL;
   ```

2. Add the `GITHUB_TOKEN` environment variable

3. Restart your application

4. Configure repositories for existing sites

That's it! Your Auditvia instance is now ready to create GitHub Issues.
